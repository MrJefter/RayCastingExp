#include <iostream>
#include "TXLib.h"

using namespace std;

char mapArray[161][161] = {
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"####################M###################M###################M###################M###################M###################M#######################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"####################M...................M###################M...................M###################M...................M#######################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"####################M...................M###################M...................M###################M...................M#######################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"####################M...................M###################M...................M###################M...................M#######################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"####################M...................M###################M...................M###################M...................M#######################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"#####################...................................................................................................########################################",
"####################M...................M###################M...................M###################M...................M#######################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"#####################...................#####################...................#####################...................########################################",
"####################M###################M###################M###################M###################M###################M#######################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
"################################################################################################################################################################",
};

int main() {
    HDC wallTexture = txLoadImage("wall_texture.bmp", 200, 200);
    float xView, yView, xPos = 30, yPos = 80, winXCounter, rayLenght, shiftSpeed = 0.5;
    float angle = 0;
    txCreateWindow(640, 200);
    txUpdateWindow(false);
    bool isSoundPlaying = false;

    char keyTmp;
    char wKey = 87, aKey = 65, sKey = 83, dKey = 68, qKey = 81, eKey = 69;
    while (true) {
        xView = xPos + cos(angle) * 50;
        yView = yPos + sin(angle) * 50;
        winXCounter = 0;
        COLORREF tempColor = RGB (50, 50, 50);
        txSetColor(tempColor);
        int bgGrad = 200;
        while (tempColor != RGB (0, 0, 0)) {
            txLine(0, bgGrad, 640, bgGrad);
            tempColor = RGB (GetRValue(tempColor) - 1, GetGValue(tempColor) - 1, GetBValue(tempColor) - 1);
            txSetColor(tempColor);
            bgGrad--;
        }
        for (float xCount = angle - (3.14/180)*30; xCount < angle + (3.14/180)*30; xCount += 1.0/640.0) {
            float yCount;
            for (yCount = 1; yCount <= 160; yCount++) {
                if (mapArray[(int)(xPos + cos(xCount) * yCount)][(int)(yPos + sin(xCount) * yCount)] == '#' || mapArray[(int)(xPos + cos(xCount) * yCount)][(int)(yPos + sin(xCount) * yCount)] == 'M') {
                    rayLenght = (int)sqrt(pow(cos(xCount) * yCount, 2) + pow(sin(xCount) * yCount, 2));
                    break;
                }
                rayLenght = -1;
            }

            if (rayLenght != -1) {
                if (255 - rayLenght*3 >= 0) {
                    if (mapArray[(int)(xPos + cos(xCount) * yCount)][(int)(yPos + sin(xCount) * yCount)] == '#') {
                        txSetColor(RGB (0, 255 - rayLenght*3, 0));
                        txSetFillColor(RGB (0, 255 - rayLenght*3, 0));
                    }
                    else if (mapArray[(int)(xPos + cos(xCount) * yCount)][(int)(yPos + sin(xCount) * yCount)] == 'M') {
                        txSetColor(RGB (255 - rayLenght*3, 0, 0));
                        txSetFillColor(RGB (255 - rayLenght*3, 0, 0));
                    }
                }
                else {
                    txSetColor(RGB (0, 0, 0));
                    txSetFillColor(RGB (0, 0, 0));
                }
                txLine(winXCounter, ((200 - 200 / (1 + 0.08 * rayLenght)) / 2), winXCounter, (200 - (200 - 200 / (1 + 0.04 * rayLenght)) / 2));
            }
            winXCounter++;
        }
        txRedrawWindow();
        if (GetKeyState(16) < -126) shiftSpeed = 1.5;
        else shiftSpeed = 1;
        if ((GetKeyState(wKey) < -126 || GetKeyState(aKey) < -126 || GetKeyState(sKey) < -126 || GetKeyState(dKey) < -126)) {
            if (!isSoundPlaying) {
                txPlaySound("running_sound");
                isSoundPlaying = true;
            }
        }
        else {
            txPlaySound(0);
            isSoundPlaying = false;
        }
        if (GetKeyState(wKey) < -126) {
            if (mapArray[(int)(xPos + (xView-xPos)/40)][(int)(yPos + (yView-yPos)/40)] == '.') {
                xPos = xPos + (xView-xPos)/(80 / shiftSpeed);
                yPos = yPos + (yView-yPos)/(80 / shiftSpeed);
            }
        }
        if (GetKeyState(sKey) < -126) {
            if (mapArray[(int)(xPos - (xView-xPos)/40)][(int)(yPos - (yView-yPos)/40)] == '.') {
                xPos = xPos - (xView-xPos)/(80 / shiftSpeed);
                yPos = yPos - (yView-yPos)/(80 / shiftSpeed);
            }
        }
        if (GetKeyState(aKey) < -126) {
            if (mapArray[(int)(xPos - (cos(angle+(3.14/180)*90)*50)/40)][(int)(yPos - (sin(angle+(3.14/180)*90)*50)/40)] == '.') {
                xPos = xPos + (cos(angle-(3.14/180)*90)*50)/(80 / shiftSpeed);
                yPos = yPos + (sin(angle-(3.14/180)*90)*50)/(80 / shiftSpeed);
            }
        }
        if (GetKeyState(dKey) < -126) {
            if (mapArray[(int)(xPos + (cos(angle+(3.14/180)*90)*50)/40)][(int)(yPos + (sin(angle+(3.14/180)*90)*50)/40)] == '.') {
                xPos = xPos + (cos(angle+(3.14/180)*90)*50)/(80 / shiftSpeed);
                yPos = yPos + (sin(angle+(3.14/180)*90)*50)/(80 / shiftSpeed);
            }
        }
        if (GetKeyState(qKey) < -126) {
            angle -= (0.04 * shiftSpeed);
        }
        if (GetKeyState(eKey) < -126) {
            angle += (0.04 * shiftSpeed);
        }
        txSetFillColor(RGB (0, 0, 0));
        txClear();
    }
}
